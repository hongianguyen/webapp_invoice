<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Snap & Upload</title>
    <style>
        body { font-family: system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; padding: 20px; }
        .container { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        video { width: 100%; border-radius: 12px; background: #000; margin-bottom: 15px; }
        button { background: #1a73e8; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 10px; }
        .hidden { display: none; }
        #status { margin-top: 20px; font-size: 14px; color: #d93025; padding: 10px; background: #fce8e6; border-radius: 4px; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #dadce0; font-size: 14px; }
        textarea { min-height: 120px; }
        .section-title { margin: 12px 0 8px; font-size: 14px; color: #5f6368; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <h2>Drive Camera App</h2>
    <button id="auth_btn">1. Sign in to Google</button>
    <input id="vision_key" type="password" placeholder="Vision API Key (not saved)">
    
    <div id="camera_section" class="hidden">
        <video id="video" autoplay playsinline></video>
        <button id="snap_btn">2. SNAP PHOTO</button>
    </div>

    <div id="upload_section" class="hidden">
        <canvas id="canvas" style="width:100%; border-radius:8px;"></canvas>
        <button id="upload_btn">3. UPLOAD PHOTO</button>
    </div>

    <div id="ocr_section" class="hidden">
        <div class="section-title">Extracted Text (edit if needed)</div>
        <textarea id="ocr_text" placeholder="OCR text will appear here..."></textarea>
        <div class="section-title">Receipt / Invoice Details</div>
        <input id="field_vendor" placeholder="Vendor / Merchant">
        <input id="field_date" placeholder="Date (YYYY-MM-DD)">
        <input id="field_total" placeholder="Total Amount">
        <input id="field_tax" placeholder="Tax (optional)">
        <input id="field_currency" placeholder="Currency (e.g., USD)">
        <button id="confirm_btn">4. CONFIRM & UPLOAD TO SHEET</button>
    </div>

    <div id="status">Checking for Google Services...</div>
</div>

<script>
    const CLIENT_ID = '725359001871-8p81bekdai3rdpn5igsr291d4p6hn0jt.apps.googleusercontent.com';
    const FOLDER_ID = '1IJ4wTZMfNn9MleyDudu13B2OjE9HvKcC';
    const SHEET_ID = '1Vr5478x2sF-tIR9ra319eXRVtanWIyhBoPLEowg1fHQ';
    const SHEET_RANGE = 'Sheet1!A:F';
    const VISION_API_KEY = '';

    let tokenClient;
    let accessToken = null;
    let lastUploadFileId = null;
    let visionApiKey = "";
    const visionKeyInput = document.getElementById('vision_key');
    const savedVisionKey = localStorage.getItem('vision_api_key') || "";
    if (savedVisionKey) {
        visionApiKey = savedVisionKey;
        visionKeyInput.value = savedVisionKey;
    }

    // --- 1. THE FORCE LOADER ---
    function startApp() {
        console.log("Checking for Google Library...");
        if (typeof google !== 'undefined' && google.accounts) {
            initGis();
        } else {
            document.getElementById('status').innerText = "STUCK: Google Script is being blocked by your browser/ad-blocker.";
        }
    }

    function initGis() {
        try {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: [
                    'https://www.googleapis.com/auth/drive.file',
                    'https://www.googleapis.com/auth/spreadsheets'
                ].join(' '),
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    document.getElementById('auth_btn').classList.add('hidden');
                    document.getElementById('camera_section').classList.remove('hidden');
                    document.getElementById('status').innerText = "Logged in!";
                    startCamera();
                },
            });
            document.getElementById('status').innerText = "Ready. Click Sign In.";
            document.getElementById('status').style.background = "#e6f4ea";
            document.getElementById('status').style.color = "#1e8e3e";
        } catch (e) {
            document.getElementById('status').innerText = "Error initializing: " + e.message;
        }
    }

    // --- 2. THE REST OF THE LOGIC ---
    document.getElementById('auth_btn').onclick = () => tokenClient.requestAccessToken();

    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('video').srcObject = stream;
    }

    document.getElementById('snap_btn').onclick = () => {
        const v = document.getElementById('video');
        const c = document.getElementById('canvas');
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        document.getElementById('camera_section').classList.add('hidden');
        document.getElementById('upload_section').classList.remove('hidden');
    };

    document.getElementById('upload_btn').onclick = async () => {
        document.getElementById('status').innerText = "Uploading...";
        document.getElementById('canvas').toBlob(async (blob) => {
            const metadata = { name: `Snap_${Date.now()}.jpg`, parents: [FOLDER_ID] };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);

            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + accessToken },
                body: form
            });
            if (res.ok) {
                const data = await res.json();
                lastUploadFileId = data.id || null;
                document.getElementById('status').innerText = "Photo uploaded. Running OCR...";
                await runOcrFromCanvas();
            } else {
                document.getElementById('status').innerText = "Upload failed.";
            }
        }, 'image/jpeg');
    };

    async function runOcrFromCanvas() {
        const c = document.getElementById('canvas');
        const ocrText = document.getElementById('ocr_text');
        const status = document.getElementById('status');
        document.getElementById('upload_section').classList.add('hidden');
        document.getElementById('ocr_section').classList.remove('hidden');
        status.innerText = "OCR in progress...";
        try {
            const activeKey = visionApiKey || VISION_API_KEY;
            if (!activeKey) {
                status.innerText = "Enter Vision API Key before running OCR.";
                return;
            }
            const prepared = prepareCanvasForVision(c);
            const text = await runVisionOcr(prepared, activeKey);
            ocrText.value = text.trim();
            const parsed = parseReceipt(text);
            fillForm(parsed);
            status.innerText = "Review the extracted data and confirm.";
        } catch (e) {
            status.innerText = "OCR failed: " + e.message;
        }
    }

    async function runVisionOcr(canvas, apiKey) {
        const base64 = canvasToBase64(canvas);
        const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                requests: [{
                    image: { content: base64 },
                    features: [{ type: 'DOCUMENT_TEXT_DETECTION' }],
                    imageContext: { languageHints: ['vi'] }
                }]
            })
        });

        if (!res.ok) {
            let detail = "";
            try {
                const errorPayload = await res.json();
                detail = errorPayload?.error?.message ? ` ${errorPayload.error.message}` : "";
            } catch (_) {
                // ignore JSON parse errors
            }
            throw new Error("Vision API request failed." + detail);
        }
        const data = await res.json();
        if (data?.responses?.[0]?.error?.message) {
            throw new Error(`Vision API error: ${data.responses[0].error.message}`);
        }
        const annotation = data.responses?.[0]?.fullTextAnnotation?.text
            || data.responses?.[0]?.textAnnotations?.[0]?.description
            || "";
        return annotation;
    }

    function canvasToBase64(canvas) {
        const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
        return dataUrl.split(',')[1] || "";
    }

    function prepareCanvasForVision(sourceCanvas) {
        let working = sourceCanvas;
        // Auto-rotate if landscape (most receipts are portrait)
        if (working.width > working.height) {
            working = rotateCanvas90(working);
        }
        // Mild upscale only; Vision works better with original color.
        return upscaleCanvas(working, 2);
    }

    function upscaleCanvas(sourceCanvas, scale) {
        const w = Math.round(sourceCanvas.width * scale);
        const h = Math.round(sourceCanvas.height * scale);
        const temp = document.createElement('canvas');
        temp.width = w;
        temp.height = h;
        const ctx = temp.getContext('2d');
        ctx.drawImage(sourceCanvas, 0, 0, w, h);
        return temp;
    }

    function preprocessCanvasForOcr(sourceCanvas) {
        const scale = 2;
        const w = sourceCanvas.width * scale;
        const h = sourceCanvas.height * scale;
        const temp = document.createElement('canvas');
        temp.width = w;
        temp.height = h;
        const ctx = temp.getContext('2d');

        // Upscale for better OCR accuracy
        ctx.drawImage(sourceCanvas, 0, 0, w, h);

        const imageData = ctx.getImageData(0, 0, w, h);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            // Grayscale + simple thresholding
            const gray = 0.299 * r + 0.587 * g + 0.114 * b;
            const v = gray > 160 ? 255 : 0;
            data[i] = v;
            data[i + 1] = v;
            data[i + 2] = v;
        }
        ctx.putImageData(imageData, 0, 0);
        return temp;
    }

    function rotateCanvas90(sourceCanvas) {
        const temp = document.createElement('canvas');
        temp.width = sourceCanvas.height;
        temp.height = sourceCanvas.width;
        const ctx = temp.getContext('2d');
        ctx.translate(temp.width / 2, temp.height / 2);
        ctx.rotate(Math.PI / 2);
        ctx.drawImage(sourceCanvas, -sourceCanvas.width / 2, -sourceCanvas.height / 2);
        return temp;
    }

    function cropCanvasToContent(sourceCanvas) {
        const ctx = sourceCanvas.getContext('2d');
        const { width, height } = sourceCanvas;
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;
        const threshold = 200;
        let minX = width, minY = height, maxX = 0, maxY = 0;
        let found = false;

        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                const idx = (y * width + x) * 4;
                const r = data[idx];
                const g = data[idx + 1];
                const b = data[idx + 2];
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                if (gray < threshold) {
                    found = true;
                    if (x < minX) minX = x;
                    if (y < minY) minY = y;
                    if (x > maxX) maxX = x;
                    if (y > maxY) maxY = y;
                }
            }
        }

        if (!found) return sourceCanvas;

        const padding = 10;
        minX = Math.max(minX - padding, 0);
        minY = Math.max(minY - padding, 0);
        maxX = Math.min(maxX + padding, width - 1);
        maxY = Math.min(maxY + padding, height - 1);
        const cropW = maxX - minX + 1;
        const cropH = maxY - minY + 1;

        const temp = document.createElement('canvas');
        temp.width = cropW;
        temp.height = cropH;
        const tctx = temp.getContext('2d');
        tctx.drawImage(sourceCanvas, minX, minY, cropW, cropH, 0, 0, cropW, cropH);
        return temp;
    }

    function parseReceipt(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
        const vendor = lines[0] || "";
        const dateMatch = text.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})|(\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4})/);
        const totalMatch = text.match(/(?:total|amount due|grand total)\s*[:\-]?\s*([A-Z]{0,3}\s?\$?\s?\d+[.,]\d{2})/i);
        const taxMatch = text.match(/(?:tax)\s*[:\-]?\s*([A-Z]{0,3}\s?\$?\s?\d+[.,]\d{2})/i);
        const currencyMatch = text.match(/\b(USD|EUR|GBP|JPY|CAD|AUD|VND)\b/i);

        return {
            vendor,
            date: dateMatch ? normalizeDate(dateMatch[0]) : "",
            total: totalMatch ? totalMatch[1].trim() : "",
            tax: taxMatch ? taxMatch[1].trim() : "",
            currency: currencyMatch ? currencyMatch[1].toUpperCase() : ""
        };
    }

    function normalizeDate(raw) {
        if (!raw) return "";
        const parts = raw.replace(/\//g, '-').split('-');
        if (parts[0].length === 4) {
            const [y, m, d] = parts;
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        const [p1, p2, p3] = parts;
        const year = p3.length === 2 ? `20${p3}` : p3;
        return `${year}-${p1.padStart(2, '0')}-${p2.padStart(2, '0')}`;
    }

    function fillForm(data) {
        document.getElementById('field_vendor').value = data.vendor || "";
        document.getElementById('field_date').value = data.date || "";
        document.getElementById('field_total').value = data.total || "";
        document.getElementById('field_tax').value = data.tax || "";
        document.getElementById('field_currency').value = data.currency || "";
    }

    document.getElementById('confirm_btn').onclick = async () => {
        const status = document.getElementById('status');
        if (!accessToken) {
            status.innerText = "Not authenticated.";
            return;
        }
        if (SHEET_ID === 'REPLACE_WITH_SHEET_ID') {
            status.innerText = "Set SHEET_ID before uploading.";
            return;
        }

        const payload = {
            vendor: document.getElementById('field_vendor').value.trim(),
            date: document.getElementById('field_date').value.trim(),
            total: document.getElementById('field_total').value.trim(),
            tax: document.getElementById('field_tax').value.trim(),
            currency: document.getElementById('field_currency').value.trim(),
            rawText: document.getElementById('ocr_text').value.trim(),
            driveFileId: lastUploadFileId || ""
        };

        status.innerText = "Uploading to Google Sheets...";
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_RANGE)}:append?valueInputOption=USER_ENTERED`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                values: [[
                    payload.vendor,
                    payload.date,
                    payload.total,
                    payload.tax,
                    payload.currency,
                    payload.rawText
                ]]
            })
        });

        if (res.ok) {
            status.innerText = "Success! Receipt saved to Google Sheets.";
            location.reload();
        } else {
            status.innerText = "Sheets upload failed.";
        }
    };

    visionKeyInput.addEventListener('input', (e) => {
        visionApiKey = e.target.value.trim();
        localStorage.setItem('vision_api_key', visionApiKey);
    });

    // --- 3. THE SCRIPT INJECTION ---
    const script = document.createElement('script');
    script.src = "https://accounts.google.com/gsi/client";
    script.onload = startApp; 
    document.head.appendChild(script);

    // Backup: If onload fails to trigger, try manually after 3 seconds
    setTimeout(() => { if(!tokenClient) startApp(); }, 3000);
</script>

</body>
</html>
