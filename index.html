<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Snap & Upload</title>
    <style>
        body { font-family: system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; padding: 20px; }
        .container { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        video { width: 100%; border-radius: 12px; background: #000; margin-bottom: 15px; }
        button { background: #1a73e8; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 10px; }
        .hidden { display: none; }
        #status { margin-top: 20px; font-size: 14px; color: #d93025; padding: 10px; background: #fce8e6; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Drive Camera App</h2>
    <button id="auth_btn">1. Sign in to Google</button>
    
    <div id="camera_section" class="hidden">
        <video id="video" autoplay playsinline></video>
        <button id="snap_btn">2. SNAP PHOTO</button>
    </div>

    <div id="upload_section" class="hidden">
        <canvas id="canvas" style="width:100%; border-radius:8px;"></canvas>
        <button id="upload_btn">3. UPLOAD TO DRIVE</button>
    </div>

    <div id="status">Checking for Google Services...</div>
</div>

<script>
    const CLIENT_ID = '725359001871-8p81bekdai3rdpn5igsr291d4p6hn0jt.apps.googleusercontent.com';
    const FOLDER_ID = '1IJ4wTZMfNn9MleyDudu13B2OjE9HvKcC';

    let tokenClient;
    let accessToken = null;

    // --- 1. THE FORCE LOADER ---
    function startApp() {
        console.log("Checking for Google Library...");
        if (typeof google !== 'undefined' && google.accounts) {
            initGis();
        } else {
            document.getElementById('status').innerText = "STUCK: Google Script is being blocked by your browser/ad-blocker.";
        }
    }

    function initGis() {
        try {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    document.getElementById('auth_btn').classList.add('hidden');
                    document.getElementById('camera_section').classList.remove('hidden');
                    document.getElementById('status').innerText = "Logged in!";
                    startCamera();
                },
            });
            document.getElementById('status').innerText = "Ready. Click Sign In.";
            document.getElementById('status').style.background = "#e6f4ea";
            document.getElementById('status').style.color = "#1e8e3e";
        } catch (e) {
            document.getElementById('status').innerText = "Error initializing: " + e.message;
        }
    }

    // --- 2. THE REST OF THE LOGIC ---
    document.getElementById('auth_btn').onclick = () => tokenClient.requestAccessToken();

    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('video').srcObject = stream;
    }

    document.getElementById('snap_btn').onclick = () => {
        const v = document.getElementById('video');
        const c = document.getElementById('canvas');
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        document.getElementById('camera_section').classList.add('hidden');
        document.getElementById('upload_section').classList.remove('hidden');
    };

    document.getElementById('upload_btn').onclick = async () => {
        document.getElementById('status').innerText = "Uploading...";
        document.getElementById('canvas').toBlob(async (blob) => {
            const metadata = { name: `Snap_${Date.now()}.jpg`, parents: [FOLDER_ID] };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);

            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + accessToken },
                body: form
            });
            if (res.ok) {
                document.getElementById('status').innerText = "SUCCESS! Check your folder.";
                location.reload();
            } else {
                document.getElementById('status').innerText = "Upload failed.";
            }
        }, 'image/jpeg');
    };

    // --- 3. THE SCRIPT INJECTION ---
    const script = document.createElement('script');
    script.src = "https://accounts.google.com/gsi/client";
    script.onload = startApp; 
    document.head.appendChild(script);

    // Backup: If onload fails to trigger, try manually after 3 seconds
    setTimeout(() => { if(!tokenClient) startApp(); }, 3000);
</script>

</body>
</html>
